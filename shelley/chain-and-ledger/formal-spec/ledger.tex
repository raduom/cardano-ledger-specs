\section{Ledger State Transition}
\label{sec:ledger-trans}

Figure~\ref{fig:rules:ledger} now separates the cases where all scripts
validate in a transaction and the case where there is one that does not.
The cases are distinguished by the use of the $\TxValTag$ tag. 

Besides fee collection, no side effects should occur when processing a
transaction containing a script that does not validate. That is, no
delegation or pool state updates, or update proposals should be
applied. The UTxO rule is still applied, as this is where the correctness of the
validation tag is verified, and script fees are collected.

\begin{figure}
  \begin{equation}
    \label{eq:ledger}
    \inference[ledger-V]
    {
      \fun{txvaltag}~{tx} \in \ValTag \\~\\
      {
        \begin{array}{c}
          \var{slot} \\
          \var{txIx} \\
          \var{pp} \\
          \var{tx}\\
          \var{reserves}
        \end{array}
      }
      \vdash
      dpstate \trans{\hyperref[fig:rules:delegation-sequence]{delegs}}{
                     \fun{txcerts}~\var{tx}} dpstate'
      \\~\\
      (\var{dstate}, \var{pstate}) \leteq \var{dpstate} \\
      (\var{stkCreds}, \_, \_, \_, \_, \var{genDelegs}) \leteq \var{dstate} \\
      (\var{stpools}, \_, \_, \_) \leteq \var{pstate} \\
      \\~\\
      {
        \begin{array}{c}
        \var{slot} \\
        \var{pp} \\
        \var{stkCreds} \\
        \var{stpools} \\
        \var{genDelegs} \\
        \end{array}
      }
      \vdash \var{utxoSt} \trans{\hyperref[fig:rules:utxow-shelley]{utxow}}{tx} \var{utxoSt'}
    }
    {
      \begin{array}{c}
        \var{slot} \\
        \var{txIx} \\
        \var{pp} \\
        \var{reserves}
      \end{array}
      \vdash
      \left(
        \begin{array}{ll}
          \var{utxoSt} \\
          \var{dpstate} \\
        \end{array}
      \right)
      \trans{ledger}{tx}
      \left(
        \begin{array}{ll}
          \varUpdate{utxoSt'} \\
          \varUpdate{dpstate'} \\
        \end{array}
      \right)
    }
  \end{equation}
  %
  \nextdef
  %
  \begin{equation}
    \label{eq:ledger}
    \inference[ledger-NV]
    {
      \fun{txvaltag}~{tx} \in \InValTag \\~\\
      (\var{dstate}, \var{pstate}) \leteq \var{dpstate} \\
      (\var{stkCreds}, \_, \_, \_, \_, \var{genDelegs}) \leteq \var{dstate} \\
      (\var{stpools}, \_, \_, \_) \leteq \var{pstate} \\
      \\~\\
      {
        \begin{array}{c}
        \var{slot} \\
        \var{pp} \\
        \var{stkCreds} \\
        \var{stpools} \\
        \var{genDelegs} \\
        \end{array}
      }
      \vdash \var{utxoSt} \trans{\hyperref[fig:rules:utxow-shelley]{utxow}}{tx} \var{utxoSt'}
    }
    {
      \begin{array}{c}
        \var{slot} \\
        \var{txIx} \\
        \var{pp} \\
        \var{reserves}
      \end{array}
      \vdash
      \left(
        \begin{array}{ll}
          \var{utxoSt} \\
          \var{dpstate} \\
        \end{array}
      \right)
      \trans{ledger}{tx}
      \left(
        \begin{array}{ll}
          \varUpdate{utxoSt'} \\
          \var{dpstate} \\
        \end{array}
      \right)
    }
  \end{equation}
  \caption{Ledger inference rules}
  \label{fig:rules:ledger}
\end{figure}

\clearpage

\begin{note}
LEDGERS rule left in to consider any problems here associated with 2-step
script validation
\end{note}

\begin{figure}[hbt]
  \begin{equation}
    \label{eq:ledgers-base}
    \inference[Seq-ledger-base]
    {
      ((\var{utxo},~\var{deposits},~\var{fees},~\var{us})
      ,~(\var{ds},~\var{ps}))
      \leteq\var{ls}
      \\
      (\var{pup},~\var{aup},~\var{favs},~\var{avs}) \leteq\var{us}
      \\
      (\var{stkeys},~\var{rewards},~\var{delegations}, ~\var{ptrs},~\var{fGenDelegs},~\var{genDelegs})
      \leteq\var{ds}
      \\
      (\var{stpools},~\var{poolParams},~\var{retiring},~\var{cs})\leteq\var{ps}
      \\~\\
      {\begin{array}{r@{~\leteq~}l}
        \var{favs'} & \{\var{s}\mapsto\var{v}\in\var{favs} ~\mid~ s>\var{slot}\}
        \\
        \var{avs'}
        & \var{avs}\unionoverrideRight\fun{newAVs}~\var{avs}~(\var{favs}\setminus\var{favs'})
      \end{array}}
      \\~\\
      \var{curr}\leteq
      \{
        (\var{s},~\var{gkh})\mapsto\var{vkh}\in\var{fGenDelegs}
        ~\mid~
        \var{s}\leq\var{slot}
      \}\\
      \var{genDelegs'}\leteq
      \left\{
        \var{gkh}\mapsto\var{vkh}
        ~\mathrel{\Bigg|}~
        {
          \begin{array}{l}
            (\var{s},~\var{gkh})\mapsto\var{vkh}\in\var{curr}\\
            \var{s}=\max\{s'~\mid~(s',~\var{gkh})\in\dom{\var{curr}}\}
          \end{array}
        }
      \right\}
      \\~\\
      \var{us'}\leteq(\var{pup},~\var{aup},~\var{favs'},~\var{avs'})
      \\
      \var{ds'}\leteq
      (\var{stkeys},~\var{rewards},~\var{delegations},~\var{ptrs},
      ~\var{fGenDelegs}\setminus\var{curr},~\var{genDelegs}\unionoverrideRight\var{genDelegs'})
      \\
      \var{oldGenDelegs}\leteq\range((\dom\var{genDelegs'})\restrictdom\var{genDelegs})
      \\
      \var{cs'}\leteq(\var{oldGenDelegs}\subtractdom\var{cs})\unionoverrideRight
      \{\var{hk}\mapsto 0~\mid~\var{hk}\in\range{genDelegs'}\}
      \\
      \var{ps'}\leteq(\var{stpools},~\var{poolParams},~\var{retiring},~\var{cs'})
      \\
      \var{ls'}\leteq((\var{utxo},~\var{deposits},~\var{fees},~\var{us'}),~(\var{ds'},~\var{ps'}))
    }
    {
      \begin{array}{r}
        \var{slot}\\
        \var{pp}\\
        \var{reserves}
      \end{array}
      \vdash \var{ls} \trans{ledgers}{\epsilon} \varUpdate{\var{ls'}}
    }
  \end{equation}

  \nextdef

  \begin{equation}
    \label{eq:ledgers-induct}
    \inference[Seq-ledger-ind]
    {
      {
        \begin{array}{r}
          \var{slot}\\
          \var{pp}\\
          \var{reserves}
        \end{array}
      }
      \vdash
      \var{ls}
      \trans{ledgers}{\Gamma}
      \var{ls'}
      &
      {
        \begin{array}{r}
          \var{slot}\\
          \mathsf{len}~\Gamma - 1\\
          \var{pp}\\
          \var{reserves}
        \end{array}
      }
      \vdash
        \var{ls'}
        \trans{\hyperref[fig:rules:ledger]{ledger}}{c}
        \var{ls''}
    }
    {
      \begin{array}{r}
        \var{slot}\\
        \var{pp}\\
        \var{reserves}
      \end{array}
    \vdash
      \var{ls}
      \trans{ledgers}{\Gamma; c}
      \varUpdate{\var{ls''}}
    }
  \end{equation}
  \caption{Ledger sequence rules}
  \label{fig:rules:ledger-sequence}
\end{figure}
